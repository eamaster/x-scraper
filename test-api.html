<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - X Scraper</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00aaff; }
        h2 { color: #ffff00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¬ X Scraper - API Diagnostic Tool</h1>
        <p class="info">This page tests the API and shows raw responses</p>

        <h2>Quick Tests:</h2>
        <button onclick="testUser()">Test: Get User (elonmusk)</button>
        <button onclick="testSearch()">Test: Search (AI)</button>
        <button onclick="testTrends()">Test: Trends (Worldwide)</button>
        <button onclick="clearResults()">Clear</button>

        <h2>Results:</h2>
        <div id="results"></div>
    </div>

    <!-- Optional: Load worker-config.js for production (file is gitignored) -->
    <script src="worker-config.js" onerror="console.log('No worker-config.js found - Worker URL must be set')"></script>
    <script>
        function resolveWorkerURL() {
            if (typeof window.WORKER_URL_OVERRIDE === 'string' &&
                window.WORKER_URL_OVERRIDE &&
                window.WORKER_URL_OVERRIDE !== 'https://YOUR_WORKER.subdomain.workers.dev') {
                console.log('ðŸ”§ Using WORKER_URL_OVERRIDE from worker-config.js (test)');
                return window.WORKER_URL_OVERRIDE;
            }
            const host = (window.location && window.location.hostname || '').toLowerCase();
            if (host === 'hesam.me') {
                console.log('ðŸŒ Using built-in production Worker URL for hesam.me (test)');
                return 'https://twitter-api-proxy.smah0085.workers.dev';
            }
            throw new Error('API configuration not found for test page.');
        }
        const WORKER_URL = resolveWorkerURL();
        const results = document.getElementById('results');

        function dget(obj, path) {
            if (!obj || !path) return undefined;
            return path
                .replace(/\[(\d+)\]/g, '.$1')
                .split('.')
                .reduce((o, k) => (o && k in o ? o[k] : undefined), obj);
        }

        function normalizeUser(json) {
            const candidates = [
                json,
                dget(json, 'result'),
                dget(json, 'user'),
                dget(json, 'data.user'),
                dget(json, 'data.user.result'),
                dget(json, 'core.user_results.result'),
            ].filter(Boolean);

            let u = null;
            for (const c of candidates) {
                if (dget(c, 'legacy')) {
                    u = c.legacy;
                    break;
                }
                if (dget(c, 'user.legacy')) {
                    u = c.user.legacy;
                    break;
                }
            }

            if (!u && dget(json, 'globalObjects.users')) {
                const users = dget(json, 'globalObjects.users');
                const first = Object.values(users)[0];
                if (first) u = first;
            }

            const name = dget(u, 'name') || dget(json, 'user.name') || '';
            const username = dget(u, 'screen_name') || dget(json, 'user.screen_name') || '';

            const description = dget(u, 'description') || '';
            const avatar =
                dget(u, 'profile_image_url_https') ||
                dget(u, 'profile_image_url') ||
                '';
            const verified = !!(dget(u, 'verified') || dget(u, 'is_blue_verified'));

            const tweets = dget(u, 'statuses_count');
            const followers = dget(u, 'followers_count');
            const following = dget(u, 'friends_count');
            const favourites = dget(u, 'favourites_count') ?? dget(u, 'favouritesCount');

            return {
                name,
                username,
                description,
                avatar,
                verified,
                metrics: { tweets, followers, following, favourites }
            };
        }

        function extractTweetsFromSearch(json) {
            let entries = dget(json, 'data.instructions') || dget(json, 'data.entry') || dget(json, 'data.entries');
            if (entries) {
                const results = [];
                const visit = (node) => {
                    if (!node) return;
                    if (Array.isArray(node)) {
                        node.forEach(visit);
                        return;
                    }
                    if (typeof node === 'object') {
                        if (node.tweet_result) {
                            const legacy = dget(node, 'tweet_result.result.legacy') || dget(node, 'tweet_result.legacy');
                            if (legacy && (legacy.full_text || legacy.text)) {
                                const user = dget(node, 'tweet_result.result.core.user_results.result');
                                results.push(user ? { legacy, user } : { legacy });
                            }
                        }
                        Object.values(node).forEach(visit);
                    }
                };
                visit(entries);
                if (results.length) return results;
            }

            if (dget(json, 'globalObjects.tweets')) {
                return Object.values(json.globalObjects.tweets).map(t => ({ legacy: t }));
            }

            if (Array.isArray(json.tweets)) return json.tweets.map(t => (t.legacy ? t : { legacy: t }));

            throw new Error('UNEXPECTED_SEARCH_PAYLOAD');
        }

        function extractCommunityTopics(json) {
            const topics = dget(json, 'data.fetch_user_community_topics.community_topics');
            if (Array.isArray(topics)) return topics;
            throw new Error('UNEXPECTED_COMMUNITY_TOPICS');
        }

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function testAPI(endpoint, params, label) {
            log(`Testing: ${label}`, 'info');
            let data = null;
            try {
                const url = new URL(WORKER_URL);
                url.searchParams.set('endpoint', endpoint);
                Object.entries(params).forEach(([key, value]) => {
                    if (value) url.searchParams.set(key, value);
                });

                log(`URL: ${url.toString()}`, 'info');
                
                const response = await fetch(url.toString());
                log(`Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                data = await response.json();
                
                log(`Response Keys: ${Object.keys(data).join(', ')}`, 'info');
                
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                results.appendChild(pre);

                // Try to find arrays in the response
                log('Searching for arrays in response...', 'info');
                findArrays(data, 'root');

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                console.error(error);
            }
            
            log('---', 'info');
            return data;
        }

        function findArrays(obj, path) {
            if (Array.isArray(obj)) {
                log(`  Found array at: ${path} (length: ${obj.length})`, 'success');
                return;
            }
            
            if (obj && typeof obj === 'object') {
                for (const key in obj) {
                    findArrays(obj[key], `${path}.${key}`);
                }
            }
        }

        async function testUser() {
            const data = await testAPI('/user', { username: 'elonmusk' }, 'Get User Profile');
            if (data) {
                try {
                    const user = normalizeUser(data);
                    log(`Normalized user: ${user.name} (@${user.username})`, 'success');
                } catch (err) {
                    log(`normalizeUser error: ${err.message}`, 'error');
                }
            }
        }

        async function testSearch() {
            let data = await testAPI('/search-v2', { query: 'AI', type: 'Top', count: '5' }, 'Search Tweets');
            if (data) {
                try {
                    const tweets = extractTweetsFromSearch(data);
                    log(`Extracted ${tweets.length} tweets from search-v2`, 'success');
                    return;
                } catch (err) {
                    log(`search-v2 parse failed: ${err.message}`, 'error');
                }
            }

            data = await testAPI('/search', { query: 'AI', type: 'Top', count: '5' }, 'Search Tweets (fallback)');
            if (data) {
                try {
                    const tweets = extractTweetsFromSearch(data);
                    log(`Extracted ${tweets.length} tweets from search fallback`, 'success');
                } catch (err) {
                    log(`search fallback parse failed: ${err.message}`, 'error');
                }
            }
        }

        async function testTrends() {
            await testAPI('/trends-by-location', { woeid: '1' }, 'Get Trends');
        }

        // Auto-run user test on load
        window.onload = () => {
            log('Diagnostic tool loaded. Click buttons to test API endpoints.', 'success');
        };
    </script>
</body>
</html>

