<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - X Scraper</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00aaff; }
        h2 { color: #ffff00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ X Scraper - API Diagnostic Tool</h1>
        <p class="info">This page tests the API and shows raw responses</p>

        <h2>Quick Tests:</h2>
        <button onclick="testUser()">Test: Get User (elonmusk)</button>
        <button onclick="testSearch()">Test: Search (AI)</button>
        <button onclick="testTrends()">Test: Trends (Worldwide)</button>
        <button onclick="clearResults()">Clear</button>

        <h2>Results:</h2>
        <div id="results"></div>
    </div>

    <!-- Optional: Load worker-config.js for production (file is gitignored) -->
    <script src="worker-config.js" onerror="console.log('No worker-config.js found - Worker URL must be set')"></script>
    <script>
        function resolveWorkerURL() {
            if (typeof window.WORKER_URL_OVERRIDE === 'string' &&
                window.WORKER_URL_OVERRIDE &&
                window.WORKER_URL_OVERRIDE !== 'https://YOUR_WORKER.subdomain.workers.dev') {
                console.log('üîß Using WORKER_URL_OVERRIDE from worker-config.js (test)');
                return window.WORKER_URL_OVERRIDE;
            }
            const host = (window.location && window.location.hostname || '').toLowerCase();
            if (host === 'hesam.me') {
                console.log('üåê Using built-in production Worker URL for hesam.me (test)');
                return 'https://twitter-api-proxy.smah0085.workers.dev';
            }
            throw new Error('API configuration not found for test page.');
        }
        const WORKER_URL = resolveWorkerURL();
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function testAPI(endpoint, params, label) {
            log(`Testing: ${label}`, 'info');
            
            try {
                const url = new URL(WORKER_URL);
                url.searchParams.set('endpoint', endpoint);
                Object.entries(params).forEach(([key, value]) => {
                    if (value) url.searchParams.set(key, value);
                });

                log(`URL: ${url.toString()}`, 'info');
                
                const response = await fetch(url.toString());
                log(`Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                
                log(`Response Keys: ${Object.keys(data).join(', ')}`, 'info');
                
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                results.appendChild(pre);

                // Try to find arrays in the response
                log('Searching for arrays in response...', 'info');
                findArrays(data, 'root');

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                console.error(error);
            }
            
            log('---', 'info');
        }

        function findArrays(obj, path) {
            if (Array.isArray(obj)) {
                log(`  Found array at: ${path} (length: ${obj.length})`, 'success');
                return;
            }
            
            if (obj && typeof obj === 'object') {
                for (const key in obj) {
                    findArrays(obj[key], `${path}.${key}`);
                }
            }
        }

        async function testUser() {
            await testAPI('/user', { username: 'elonmusk' }, 'Get User Profile');
        }

        async function testSearch() {
            await testAPI('/search-v2', { query: 'AI', type: 'Top', count: '5' }, 'Search Tweets');
        }

        async function testTrends() {
            await testAPI('/trends-by-location', { woeid: '1' }, 'Get Trends');
        }

        // Auto-run user test on load
        window.onload = () => {
            log('Diagnostic tool loaded. Click buttons to test API endpoints.', 'success');
        };
    </script>
</body>
</html>

